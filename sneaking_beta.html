<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<style>
    .invisible {
        opacity: 0;
    }
    #server_view, #player_view {
        font-size: 20px;
        display: inline-block;
        border: 2px #333 solid;
        line-height: 0em;
        position: relative;
    }
    .block {
        font-size: 2em;
        height: 1em;
        width: 1em;
        display: inline-block;
        border: 1px #ccc solid;
        opacity: 0.5;
        position: relative;
    }
    .block_P {
        background: #eee;
    }
    .block_B {
        background: #bbb;
    }
    .block_E {
        background: #cec;
    }
    .block:before {
        position: absolute;
    }

    .guard:before {
        content: 'x';
        line-height: 0.9em;
        width: 1.1em;
        text-align: center;
        color: #d00;
    }
    .block[surroundingGuards]:before {
        content: attr(surroundingGuards);
        font-size: 0.5em;
        line-height: 2em;
        width: 2em;
        text-align: center;
        color: #700;
    }


     /* ----------------------- */
    /* stage = choose_entrance */

    [stage="choose_entrance"]:before {
        position: absolute;
        content: 'Choose an entrance';
        top: 50%;
        text-align: center;
        width: 100%;
        font-size: 1.5em;
        opacity: 0.5;
        z-index: 1;
    }
    [stage="choose_entrance"] .block_E {
        border-color: #000;
        cursor: pointer;
        box-shadow: 0 0 5px 2px rgba(0,0,0,0.5);
    }
    [stage="choose_entrance"] .block_E:hover {
        opacity: 1;
    }


     /* ------------------ */
    /* stage = next_step */

    .chosen_entrance {
        opacity: 1;
    }

    .destination {
        opacity: 1;
    }
    .destination:before {
        display: inline-block;
        background: #0064ff;
        border-radius: 100%;
        width: 0.8em;
        height: 0.8em;
        content: '';
        top: 0.1em;
        left: 0.1em;
        box-shadow: 0 0 5px 1px rgba(0,0,0,0.5);
    }

    .clickable {
        cursor: pointer;
        box-shadow: 0 0 5px 2px rgba(0,0,0,0.5) inset;
        z-index: 1;
    }
    .clickable:hover {
        box-shadow: 0 0 5px 2px rgba(0,0,0,1) inset;
    }

    .visited {
        opacity: 1;
        border-color: #090;
    }


</style>
    </head>
    <body>
        <div id="server_view" class="invisible"></div>
        <div id="player_view"></div>
        <div id="buttons">
            <button id="reset">Reset</button>
            <button id="toggleView">Toggle Server View</button>
        </div>
        <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
        <script>
            var gameOver = false;
            var map = [
                [ 'P','P','P','P','P','P','E','P','P','P','P','P','P','E','P','P' ],
                [ 'P','P','P','P','P','P','P','P','P','P','P','P','P','P','P','P' ],
                [ 'P','P','B','B','P','B','B','P','P','B','B','P','B','B','P','P' ],
                [ 'P','P','B','B','P','B','B','P','P','B','B','P','B','B','P','P' ],
                [ 'P','P','P','P','P','P','B','P','P','P','P','P','P','B','P','P' ],
                [ 'E','P','B','B','B','P','P','P','P','B','B','B','P','P','P','E' ],
                [ 'P','P','B','P','P','P','B','B','P','B','P','P','P','B','B','P' ],
                [ 'P','P','P','P','B','P','P','P','P','P','P','B','P','P','P','P' ],
                [ 'P','P','P','P','P','P','P','P','P','P','P','P','P','P','P','P' ],
                [ 'P','P','B','B','P','B','B','P','P','B','B','P','B','B','P','P' ],
                [ 'P','P','B','B','P','B','B','P','P','B','B','P','B','B','P','P' ],
                [ 'P','P','P','P','P','P','B','P','P','P','P','P','P','B','P','P' ],
                [ 'P','P','B','B','B','P','P','P','P','B','B','B','P','P','P','E' ],
                [ 'P','P','P','P','P','P','B','P','P','P','P','P','P','B','P','P' ],
                [ 'E','P','B','B','B','P','P','P','P','B','B','B','P','P','P','P' ],
                [ 'P','P','B','P','P','P','B','B','P','B','P','P','P','B','B','P' ],
                [ 'P','P','P','P','B','P','P','P','P','P','P','B','P','P','P','P' ],
                [ 'P','P','P','P','P','P','E','P','P','P','P','P','P','E','P','P' ],
            ];
            var map_buildings = [];
            var map_paths = [];

            $('#reset').click(drawMaps);

            $('#toggleView').click(function(){
                $('#server_view').toggleClass('invisible');
            });

            function drawMaps(){
                gameOver = false;
                $('#server_view').addClass('invisible');
                var map_html = '';

                map.forEach(function(row, row_i){
                    map_html += '<div class="row">';
                    row.forEach(function(block, col_i){
                        var block_id = 'block_'+row_i+'_'+col_i;

                        if(block=='B') map_buildings.push({row: row_i, col: col_i, block_id: block_id});
                        if(block=='P') map_paths.push({row: row_i, col: col_i, block_id: block_id});

                        map_html += '<div class="block block_'+block+'" id="'+block_id+'" row="'+row_i+'" col="'+col_i+'" />';
                    });
                    map_html += '</div>';
                });
                $('#server_view').html(map_html);
                $('#player_view').html(map_html).attr('stage', 'choose_entrance');
            }


            function chooseEntrance(){
                if(gameOver) return;

                if($('#player_view[stage="choose_entrance"]').length==0) return;
                var block = $(this);
                if(!block.hasClass('block_E')){
                    alert('Not an entrance block!');
                    return false;
                }
                block.addClass('chosen_entrance').addClass('current_location');
                $('#server_view #'+block.attr('id')).addClass('chosen_entrance').addClass('current_location');
                setupBoard();
            }
            $('#player_view').on('click', '.block_E', chooseEntrance);


            function setClickables(){
                if(gameOver) return;

                $('#player_view .block').removeClass('clickable');
                var row = parseInt($('.current_location').attr('row'));
                var col = parseInt($('.current_location').attr('col'));
                var rows = [row-1, row, row+1];
                var cols = [col-1, col, col+1];
                rows.forEach(function(row_i){
                    cols.forEach(function(col_i){
                        if(row==row_i && col==col_i) return;

                        $('#player_view #block_'+row_i+'_'+col_i+':not(.opened)').addClass('clickable');
                    });
                });
            }


            function setServerHints(){
                if(gameOver) return;

                $('#server_view .block:not(.guard, .destination)').each(function(){
                    var block = $(this);
                    var row = parseInt(block.attr('row'));
                    var col = parseInt(block.attr('col'));
                    var rows = [row-1, row, row+1];
                    var cols = [col-1, col, col+1];

                    var surroundingGuards = 0;
                    rows.forEach(function(row_i){
                        cols.forEach(function(col_i){
                            if($('#server_view #block_'+row_i+'_'+col_i).hasClass('guard')) surroundingGuards++;
                        });
                    });

                    if(surroundingGuards>0) block.attr('surroundingGuards', surroundingGuards);
                });

            }


            function setupBoard(){
                if(gameOver) return;

                // set destination
                var numRows = map.length-1;
                var numCols = map[0].length-1;
                var possibleDestinationBlocks = $('#player_view .block_B:not([row="0"], [row="'+numRows+'"], [col="0"], [col="'+numCols+'"])');
                var destination = possibleDestinationBlocks.eq( Math.floor(Math.random()*possibleDestinationBlocks.length) );
                destination.addClass('destination');
                $('#server_view #'+destination.attr('id')).addClass('destination');

                // add guards
                var difficulty = 5;
                var guards = ( numRows+numCols ) * ( 1+( difficulty/10 ) );

                var possibleGuardedBlocks = $('#server_view .block_P:not([row="0"], [row="'+numRows+'"], [col="0"], [col="'+numCols+'"])');
                possibleGuardedBlocks = shuffleArray(possibleGuardedBlocks);
                var guardedBlocks = $(possibleGuardedBlocks.splice(0,guards));

                guardedBlocks.addClass('guard');

                setServerHints();
                setHint();

                setClickables();
                $('#player_view').attr('stage', 'next_step');
            }


            function moveToBlock(){
                if(gameOver) return;

                var block = $(this);
                if(!block.hasClass('clickable')){
                    alert('Not a clickable block!');
                    return false;
                }
                var server_block = $('#server_view #'+block.attr('id'));
                if(server_block.hasClass('guard')){
                    alert('Game Over!');
                    gameOver = true;
                    $('#server_view').removeClass('invisible');
                    return false;
                }
                if(server_block.hasClass('destination')){
                    alert('You Win!');
                    gameOver = true;
                    $('#server_view').removeClass('invisible');
                    return false;
                }

                $('.current_location').removeClass('current_location');
                block.addClass('current_location').addClass('visited');
                $('#server_view #'+block.attr('id')).addClass('current_location');
                setClickables();
                setHint();

            }
            $('#player_view').on('click', '.clickable', moveToBlock);


            function setHint(){
                if(gameOver) return;

                var surroundingGuards = $('#server_view .current_location').attr('surroundingGuards');
                if(surroundingGuards) $('#player_view .current_location').attr('surroundingGuards', surroundingGuards);
            }


            function shuffleArray(array) {
                for (var i = array.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
                return array;
            }
        </script>

    </body>
</html>
